#include <stdio.h>
#include <stdlib.h>
#include <time.h>
#include <string.h>
#include "game.h"
#include "init_periph.h"

void showField(){
    for(int i = 0; i < 32; i++) {
        for (int j = 0; j < 64; j++) {
            dispMap[i][j] = map[i][j];
        }
    }
    addPlayer(dispMap);
    for(int i = 0; i < 32; i++){
        for(int j = 0 ; j < 64; j++){
            printf("%c", dispMap[i][j]);
        }
        printf("\n");
    }
}

void addWall(){
    int opening = rand() % (31-gapSize);
    for(int i = 0; i < 32; i++){
        if( i >= opening && i <= opening + gapSize){
            map[i][63] = wallGap;
            map[i][62] = wallGap;
        }else{
            map[i][63] = wall;
            map[i][62] = wall;
        }

    }
}

void addPlayer(char m [32][64]){
    char ch;
    for(int i = 0 ; i < 5; i++){
        if(i == 0){
            ch = playerBeak;
        }else{
            ch = playerBody;
        }

        m[player[i][0]][player[i][1]] = ch;
    }
}

void updateDisplay(){
    char ch = open;
    for(int i = 0; i < 32; i++) {
        for (int j = 0; j < 64; j++) {
            if(j < 63){
                map[i][j] = map[i][j+1];
            }else{
                map[i][j] = ch;
            }
        }
    }
}

void moveUp(){
    if(player[0][0] > playerMovement-1) {
        for (int i = 0; i < 5; i++) {
            player[i][0] -= playerMovement;
        }
    }
}

void moveDown(){
    if(player[0][0] < 31-playerMovement) {
        for (int i = 0; i < 5; i++) {
            player[i][0] += playerMovement;
        }
    }
}

void update(){

    updateDisplay();
    if(space == gap){
        addWall();
        space = 0;
    }else{
        space ++;
    }

    check();
    showField();
}

void check(){
    int x = player[0][0];
    int y = player[0][1];
    if(map[x][y] == wallGap && map[x][y+1] == open){
        score ++;
        update_score(score);
    }

    for(int i = 0; i < 5; i++){
        x = player[i][0];
        y = player[i][1];
        if(map[x][y] == wall){
            started = 0;
            end_game();

            replace_startscr(1);
            //reset_screen();
            endscreen();
            for (int i = 0; i < 100; i++)
            	small_delay(9999999);

            //setup();
            //start();
    		reset();
        }
    }

}


void start(){
    srand((unsigned) 5);
    for(int i = 0; i < 32; i++){
        for(int j = 0; j < 64; j++){
            map[i][j] = open;
        }
    }
    started = 1;

//    for(int i = 0; i < 20; i++){
//        update();
//        if(check()){
//            printf("Hit the wall\n");
//            break;
//        }
//    }
//    printf("Score: %d\n", score);
}

char startscr[32][64] =
{
		{'#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#'},
		{'#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#'},
		{'#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#'},
		{'#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#'},
		{'#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#'},
		{'#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#'},
		{'#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#'},
		{'#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#'},
		{'#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#'},
		{'#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#'},
		{'#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#'},
		{'#','#','#','#','#','#','#','#','#','#','#',' ','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#'},
		{'#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#'},
		{'#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#'},
		{'#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#'},
		{'#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#'},
		{'#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#'},
		{'#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#'},
		{'#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#'},
		{'#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#'},
		{'#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#'},
		{'#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#'},
		{'#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#'},
		{'#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#'},
		{'#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#'},
		{'#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#'},
		{'#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#'},
		{'#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#'},
		{'#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#'},
		{'#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#'},
		{'#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#'},
		{'#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#','#'}

};

char endscr[32][64] =
{
		{'>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>'},
		{'>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>'},
		{'>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>'},
		{'>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>'},
		{'>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>'},
		{'>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>'},
		{'>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>'},
		{'>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>'},
		{'>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>'},
		{'>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>'},
		{'>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>'},
		{'>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>'},
		{'>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>'},
		{'>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>'},
		{'>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>'},
		{'>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>'},
		{'>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>'},
		{'>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>'},
		{'>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>'},
		{'>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>'},
		{'>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>'},
		{'>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>'},
		{'>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>'},
		{'>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>'},
		{'>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>'},
		{'>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>'},
		{'>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>'},
		{'>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>'},
		{'>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>'},
		{'>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>'},
		{'>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>'},
		{'>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>','>'},
};




void replace_startscr(int state_se)
{
	if (state_se == 0) // start state
	{
		for (int i = 0; i < 32; i++)
		{
			for (int j = 0; j < 64; j++)
			{
				scr[i][j] = startscr[i][j];
			}
		}

	}
	else
	{
		for (int i = 0; i < 32; i++)
		{
			for (int j = 0; j < 64; j++)
			{
				scr[i][j] = endscr[i][j];
			}
		}
	}

}
